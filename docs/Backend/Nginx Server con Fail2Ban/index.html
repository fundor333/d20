<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../Errori%20comuni%20Django/ rel=prev><link href=../Altro/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.40"><title>Nginx Server con Fail2Ban - Personal Docs</title><link rel=stylesheet href=../../assets/stylesheets/main.8c3ca2c6.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#proteggere-un-server-nginx-con-fail2ban class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Personal Docs" class="md-header__button md-logo" aria-label="Personal Docs" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Personal Docs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Nginx Server con Fail2Ban </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=lime data-md-color-accent=light-green aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-orange data-md-color-accent=red aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Personal Docs" class="md-nav__button md-logo" aria-label="Personal Docs" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> Personal Docs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Software </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Software </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Software%20e%20App/manga/ class=md-nav__link> <span class=md-ellipsis> Manga App e Software </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../isola/ class=md-nav__link> <span class=md-ellipsis> Problemi Isola </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Server e Backend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Server e Backend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Django%2C%20Postgrest%2C%20Nginx%20e%20Gunicorn/ class=md-nav__link> <span class=md-ellipsis> Django, Postgrest, Nginx e Gunicorn </span> </a> </li> <li class=md-nav__item> <a href=../Errori%20comuni%20Django/ class=md-nav__link> <span class=md-ellipsis> Errori comuni Django </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Nginx Server con Fail2Ban </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Nginx Server con Fail2Ban </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduzione class=md-nav__link> <span class=md-ellipsis> Introduzione </span> </a> </li> <li class=md-nav__item> <a href=#installazione-nginx class=md-nav__link> <span class=md-ellipsis> Installazione Nginx </span> </a> </li> <li class=md-nav__item> <a href=#comandi-utili-nginx class=md-nav__link> <span class=md-ellipsis> Comandi utili Nginx </span> </a> </li> <li class=md-nav__item> <a href=#impostazioni-dei-server-block class=md-nav__link> <span class=md-ellipsis> Impostazioni dei Server Block </span> </a> </li> <li class=md-nav__item> <a href=#intallazione-fail2ban class=md-nav__link> <span class=md-ellipsis> Intallazione Fail2Ban </span> </a> </li> <li class=md-nav__item> <a href=#settings-generali-fail2ban class=md-nav__link> <span class=md-ellipsis> Settings generali Fail2Ban </span> </a> </li> <li class=md-nav__item> <a href=#configurazione-di-fail2ban-per-monitoraggio-log-nginx class=md-nav__link> <span class=md-ellipsis> Configurazione di Fail2Ban per monitoraggio log Nginx </span> </a> <nav class=md-nav aria-label="Configurazione di Fail2Ban per monitoraggio log Nginx"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#introduzione_1 class=md-nav__link> <span class=md-ellipsis> Introduzione </span> </a> </li> <li class=md-nav__item> <a href=#configurazione-jail-specifici-per-nginx class=md-nav__link> <span class=md-ellipsis> Configurazione Jail specifici per Nginx </span> </a> <nav class=md-nav aria-label="Configurazione Jail specifici per Nginx"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jail-nginx-http-auth class=md-nav__link> <span class=md-ellipsis> Jail - Nginx Http Auth </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-no-script class=md-nav__link> <span class=md-ellipsis> Jail - Nginx No Script </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-bot-search-e-bad-bot class=md-nav__link> <span class=md-ellipsis> Jail - Nginx Bot Search e Bad Bot </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-no-home class=md-nav__link> <span class=md-ellipsis> Jail - Nginx No Home </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-no-proxy class=md-nav__link> <span class=md-ellipsis> Jail - Nginx No Proxy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configurazione-filter-dei-jail-abilitati class=md-nav__link> <span class=md-ellipsis> Configurazione filter dei jail abilitati </span> </a> <nav class=md-nav aria-label="Configurazione filter dei jail abilitati"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filter-nginx-http-auth class=md-nav__link> <span class=md-ellipsis> Filter - Nginx Http Auth </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-bad-bots class=md-nav__link> <span class=md-ellipsis> Filter - Nginx Bad Bots </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-bot-search class=md-nav__link> <span class=md-ellipsis> Filter - Nginx Bot Search </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-no-script class=md-nav__link> <span class=md-ellipsis> Filter - Nginx No Script </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-no-home class=md-nav__link> <span class=md-ellipsis> Filter - Nginx No Home </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-no-proxy class=md-nav__link> <span class=md-ellipsis> Filter - Nginx No Proxy </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#attivazione-delle-jail-nginx class=md-nav__link> <span class=md-ellipsis> Attivazione delle Jail Nginx </span> </a> </li> <li class=md-nav__item> <a href=#ottenere-info-su-stato-jail class=md-nav__link> <span class=md-ellipsis> Ottenere info su stato Jail </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Altro/ class=md-nav__link> <span class=md-ellipsis> Altri casi non mappati </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Esempi </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Esempi </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Esempi/Google%20implementation/ class=md-nav__link> <span class=md-ellipsis> Python e Google </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduzione class=md-nav__link> <span class=md-ellipsis> Introduzione </span> </a> </li> <li class=md-nav__item> <a href=#installazione-nginx class=md-nav__link> <span class=md-ellipsis> Installazione Nginx </span> </a> </li> <li class=md-nav__item> <a href=#comandi-utili-nginx class=md-nav__link> <span class=md-ellipsis> Comandi utili Nginx </span> </a> </li> <li class=md-nav__item> <a href=#impostazioni-dei-server-block class=md-nav__link> <span class=md-ellipsis> Impostazioni dei Server Block </span> </a> </li> <li class=md-nav__item> <a href=#intallazione-fail2ban class=md-nav__link> <span class=md-ellipsis> Intallazione Fail2Ban </span> </a> </li> <li class=md-nav__item> <a href=#settings-generali-fail2ban class=md-nav__link> <span class=md-ellipsis> Settings generali Fail2Ban </span> </a> </li> <li class=md-nav__item> <a href=#configurazione-di-fail2ban-per-monitoraggio-log-nginx class=md-nav__link> <span class=md-ellipsis> Configurazione di Fail2Ban per monitoraggio log Nginx </span> </a> <nav class=md-nav aria-label="Configurazione di Fail2Ban per monitoraggio log Nginx"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#introduzione_1 class=md-nav__link> <span class=md-ellipsis> Introduzione </span> </a> </li> <li class=md-nav__item> <a href=#configurazione-jail-specifici-per-nginx class=md-nav__link> <span class=md-ellipsis> Configurazione Jail specifici per Nginx </span> </a> <nav class=md-nav aria-label="Configurazione Jail specifici per Nginx"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jail-nginx-http-auth class=md-nav__link> <span class=md-ellipsis> Jail - Nginx Http Auth </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-no-script class=md-nav__link> <span class=md-ellipsis> Jail - Nginx No Script </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-bot-search-e-bad-bot class=md-nav__link> <span class=md-ellipsis> Jail - Nginx Bot Search e Bad Bot </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-no-home class=md-nav__link> <span class=md-ellipsis> Jail - Nginx No Home </span> </a> </li> <li class=md-nav__item> <a href=#jail-nginx-no-proxy class=md-nav__link> <span class=md-ellipsis> Jail - Nginx No Proxy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configurazione-filter-dei-jail-abilitati class=md-nav__link> <span class=md-ellipsis> Configurazione filter dei jail abilitati </span> </a> <nav class=md-nav aria-label="Configurazione filter dei jail abilitati"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filter-nginx-http-auth class=md-nav__link> <span class=md-ellipsis> Filter - Nginx Http Auth </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-bad-bots class=md-nav__link> <span class=md-ellipsis> Filter - Nginx Bad Bots </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-bot-search class=md-nav__link> <span class=md-ellipsis> Filter - Nginx Bot Search </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-no-script class=md-nav__link> <span class=md-ellipsis> Filter - Nginx No Script </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-no-home class=md-nav__link> <span class=md-ellipsis> Filter - Nginx No Home </span> </a> </li> <li class=md-nav__item> <a href=#filter-nginx-no-proxy class=md-nav__link> <span class=md-ellipsis> Filter - Nginx No Proxy </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#attivazione-delle-jail-nginx class=md-nav__link> <span class=md-ellipsis> Attivazione delle Jail Nginx </span> </a> </li> <li class=md-nav__item> <a href=#ottenere-info-su-stato-jail class=md-nav__link> <span class=md-ellipsis> Ottenere info su stato Jail </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=proteggere-un-server-nginx-con-fail2ban>Proteggere un server Nginx con Fail2Ban</h1> <h2 id=introduzione>Introduzione</h2> <p>Quando gli utenti falliscono ripetutamente l'autenticazione ad un servizio (o si impegnano in altre attività sospette), fail2ban può emettere divieti temporanei sull'indirizzo IP offensivo modificando dinamicamente il criterio del firewall in esecuzione. Ogni "jail" fail2ban funziona controllando i log scritti da un servizio per i pattern che indicano i tentativi falliti. Configurare fail2ban per monitorare i registri di Nginx è abbastanza semplice utilizzando alcuni dei filtri di configurazione inclusi e alcuni creati da noi.</p> <h2 id=installazione-nginx>Installazione Nginx</h2> <p>Aggiorna l'indice locale dei pacchetti e installa digitando:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>sudo<span class=w> </span>apt-get<span class=w> </span>update
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>nginx
</span></code></pre></div> <p>Controlla lo stato di Nginx digitando:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>systemctl<span class=w> </span>status<span class=w> </span>nginx
</span></code></pre></div> <p>Se hai bisogno dell'IP utilizza:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>ip<span class=w> </span>addr<span class=w> </span>show<span class=w> </span>eth0<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>inet<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{ print $2; }&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>sed<span class=w> </span><span class=s1>&#39;s/\/.*$//&#39;</span>
</span></code></pre></div> <p>Se Nginx sta girando correttamente dovresti vedere la landing page:</p> <h2 id=comandi-utili-nginx>Comandi utili Nginx</h2> <p>Se li sai già a memoria puoi saltare tranquillamente questa parte.</p> <p>Arresta servizio Nginx:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>sudo<span class=w> </span>systemctl<span class=w> </span>stop<span class=w> </span>nginx
</span></code></pre></div> <p>Avvia servizio Nginx:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>sudo<span class=w> </span>systemctl<span class=w> </span>start<span class=w> </span>nginx
</span></code></pre></div> <p>Riavvia servizio Nginx:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>sudo<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>nginx
</span></code></pre></div> <p>Ricarica settings senza drop connessioni (utile per cambi ai settings):</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>sudo<span class=w> </span>systemctl<span class=w> </span>reload<span class=w> </span>nginx
</span></code></pre></div> <h2 id=impostazioni-dei-server-block>Impostazioni dei Server Block</h2> <p>Anche questi passaggi fanno parte della configurazione standard di Nginx. Se già li conosci salta questa parte</p> <p>Per permettere a Nginx di servire i contenuti, è necessario creare un server block con le direttive corrette. Invece di modificare direttamente il file di configurazione predefinito (<code>/etc/nginx/nginx.conf</code>), ne creiamo uno nuovo in /etc/nginx/sites-available/miosito.com:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>server {
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>        listen 80;
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>        listen [::]:80;
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>        root /var/www/miosito.com/html;
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>        index index.html index.htm index.nginx-debian.html;
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>        server_name miosito.com www.miosito.com;
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>        location / {
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>                try_files $uri $uri/ =404;
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>        }
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>}
</span></code></pre></div> <p>Abilitiamo il file creando un collegamento alla directory sites-enabled, che Nginx legge durante l'avvio:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>sudo<span class=w> </span>ln<span class=w> </span>-s<span class=w> </span>/etc/nginx/sites-available/miosito.com<span class=w> </span>/etc/nginx/sites-enabled/
</span></code></pre></div> <h2 id=intallazione-fail2ban>Intallazione Fail2Ban</h2> <p>Una volta che il tuo server Nginx è in esecuzione puoi procedere e installare Fail2Ban:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>fail2ban
</span></code></pre></div> <h2 id=settings-generali-fail2ban>Settings generali Fail2Ban</h2> <p>Per iniziare, è necessario regolare il file di configurazione che Fail2Ban utilizza per determinare quali registri delle applicazioni monitorare e quali azioni intraprendere quando vengono trovate voci offensive. Il file fornito di default è <code>/etc/fail2ban/jail.conf</code>, ma potrebbe venire sovrascritto in caso di aggiornamento del pacchetto. Per fare modifiche, è necessario copiarlo in <code>/etc/fail2ban/jail.local</code>:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>sudo<span class=w> </span>cp<span class=w> </span>/etc/fail2ban/jail.conf<span class=w> </span>/etc/fail2ban/jail.local
</span></code></pre></div> <p>Apri il file appena copiato in modo da poter impostare il monitoraggio del registro Nginx:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>sudo<span class=w> </span>nano<span class=w> </span>/etc/fail2ban/jail.local
</span></code></pre></div> <p>Se lo desidera si può aggiungere una lista IP che non verranno soggetti alle policy di Fail2Ban, grazie alla direttiva <code>ignoreip</code>. Può essere utile ad es. per escludere l'IP dell'ufficioo di casa:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>[DEFAULT]</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=p>.</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>.</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=n>ignoreip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>127.0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>1</span><span class=err>/</span><span class=n>8</span><span class=w> </span><span class=n>IP_di_casa</span><span class=w> </span><span class=n>IP_di_ufficio</span>
</span></code></pre></div> <p>Se si vuole si può configurare un <code>bantime</code> diverso da quello di default. Il bantime è un intero espresso in secondi, il valore di default è 600 (10 minuti).</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>[DEFAULT]</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=p>.</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>.</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=n>bantime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3600</span>
</span></code></pre></div> <p>I due item successivi determinano l'ambito delle righe di registro utilizzate per determinare un client malvagio. Nello specifico individuano il momento in cui un determinato numero (direttiva <code>maxretry</code>) di tentativi viene rilevato all'interno di una particolare finestra temporale (<code>findtime</code>). Il findtime è anch'esso un intero espresso in secondi.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>[DEFAULT]
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>. . .
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>findtime = 3600   # These lines combine to ban clients that fail
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>maxretry = 6      # to authenticate 6 times within a half hour.
</span></code></pre></div> <h2 id=configurazione-di-fail2ban-per-monitoraggio-log-nginx>Configurazione di Fail2Ban per monitoraggio log Nginx</h2> <h3 id=introduzione_1>Introduzione</h3> <p>Di default l'unico jail abilitato è quello <code>[ssh]</code>. I cosiddetti <em>jail</em> all'interno di <code>/etc/fail2ban/jail.local</code> si presentano così:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>[nome-del-jail]</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=n>enabled</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c1># Disabilitato di default</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=n>filter</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=err>nome-del-filter # Uguale al nome del jail, deve esistere un file omonimo nel path /etc/fail</span><span class=mi>2</span><span class=n>ban</span><span class=err>/</span><span class=n>filter</span><span class=p>.</span><span class=n>d</span><span class=err>/</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=n>port</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=err>http,https</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=n>logpath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>%(nginx</span><span class=mi>_</span><span class=n>access_log</span><span class=err>)</span><span class=n>s</span><span class=w> </span><span class=c1># Path log da monitorare. Alternativa: %(nginx_error_log)s</span>
</span></code></pre></div> <p>La logica utilizzata dai <em>jail</em> viene definita nei <em>filter</em> in <code>/etc/fail2ban/filter.d/</code>. Per semplicità i filter vengono denominati come i jail. I <em>filter</em> si presentano così:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=k>[Definition]</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=n>failregex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>^&lt;HOST&gt; -.*METHOD.*REGEX</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=n>ignoreregex</span><span class=w> </span><span class=o>=</span>
</span></code></pre></div> <p>dove <code>failregex</code> indica il pattern da controllare nel file di log definito nel jail e <code>ignoreregex</code> i pattern da ignorare.</p> <h3 id=configurazione-jail-specifici-per-nginx>Configurazione Jail specifici per Nginx</h3> <h4 id=jail-nginx-http-auth>Jail - Nginx Http Auth</h4> <p>Per abilitare il monitoraggio dei tentativi di login cerca il jail <code>[nginx-http-auth]</code>. È l'unico jail specifico per Nginx incluso nel package Fail2Ban per Debian/Ubuntu. Impostare quindi <code>enabled = true</code> per abilitarlo.</p> <h4 id=jail-nginx-no-script>Jail - Nginx No Script</h4> <p>Per bloccare client che cercano script per eseguirli o sfruttare un exploit creiamo un jail <code>[nginx-noscript]</code>:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=k>[nginx-noscript]</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=n>enabled</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=n>port</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=err>http,https</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=n>filter</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=err>nginx-noscript</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=n>logpath</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=err>%(nginx</span><span class=mi>_</span><span class=n>access_log</span><span class=err>)</span><span class=n>s</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=n>maxretry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span>
</span></code></pre></div> <h4 id=jail-nginx-bot-search-e-bad-bot>Jail - Nginx Bot Search e Bad Bot</h4> <p>Per bloccare le richieste provenienti da mailicious bot conosciuti, creare <code>[nginx-botsearch]</code> e <code>[nginx-badbots]</code>:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=k>[nginx-botsearch]</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=n>enabled</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=n>filter</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=err>nginx-botsearch</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=n>port</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=err>http,https</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=n>logpath</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=err>%(nginx</span><span class=mi>_</span><span class=n>access_log</span><span class=err>)</span><span class=n>s</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=n>maxretry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=k>[nginx-badbots]</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=n>enabled</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=n>port</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=err>http,https</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=n>filter</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=err>nginx-badbots</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=n>logpath</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=err>%(nginx</span><span class=mi>_</span><span class=n>access_log</span><span class=err>)</span><span class=n>s</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=n>maxretry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
</span></code></pre></div> <h4 id=jail-nginx-no-home>Jail - Nginx No Home</h4> <p>Per bloccare le richieste ai contenuti web nella home directory, creare un <code>[nginx-nohome]</code>:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=k>[nginx-nohome]</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=n>enabled</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=n>port</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=err>http,https</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=n>filter</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=err>nginx-nohome</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=n>logpath</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=err>%(nginx</span><span class=mi>_</span><span class=n>access_log</span><span class=err>)</span><span class=n>s</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=n>maxretry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
</span></code></pre></div> <h4 id=jail-nginx-no-proxy>Jail - Nginx No Proxy</h4> <p>Per bloccare client che cercano di usare il nostro Nginx come open proxy, creare un <code>[nginx-noproxy</code>:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>[nginx-noproxy]</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=n>enabled</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=n>port</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=err>http,https</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=n>filter</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=err>nginx-noproxy</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=n>logpath</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=err>%(nginx</span><span class=mi>_</span><span class=n>access_log</span><span class=err>)</span><span class=n>s</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=n>maxretry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
</span></code></pre></div> <h3 id=configurazione-filter-dei-jail-abilitati>Configurazione filter dei jail abilitati</h3> <h4 id=filter-nginx-http-auth>Filter - Nginx Http Auth</h4> <p>Editare <code>/etc/fail2ban/filter.d/nginx-http-auth.conf</code>:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=k>[Definition]</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=n>failregex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>^ \</span><span class=p>[</span><span class=err>error\] \d+#\d+: \*\d+ user </span><span class=s2>&quot;</span><span class=se>\S</span><span class=s2>+&quot;</span><span class=err>:? (password mismatch|was not found in </span><span class=s2>&quot;.*&quot;</span><span class=err>), client: &lt;HOST&gt;, server: \S+, request: </span><span class=s2>&quot;</span><span class=se>\S</span><span class=s2>+ </span><span class=se>\S</span><span class=s2>+ HTTP/</span><span class=se>\d</span><span class=s2>+</span><span class=se>\.\d</span><span class=s2>+&quot;</span><span class=p>,</span><span class=w> </span><span class=err>host: </span><span class=s2>&quot;</span><span class=se>\S</span><span class=s2>+&quot;</span><span class=err>\s*$</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=w>            </span><span class=err>^</span><span class=w> </span><span class=err>\</span><span class=k>[error</span><span class=err>\</span><span class=k>]</span><span class=w> </span><span class=err>\</span><span class=n>d</span><span class=err>+</span><span class=c1>#\d+: \*\d+ no user/password was provided for basic authentication, client: &lt;HOST&gt;, server: \S+, request: &quot;\S+ \S+ HTTP/\d+\.\d+&quot;, host: &quot;\S+&quot;\s*$ # Aggiungere questa riga per avere un match sugli utenti che non hanno inserito username e password</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=n>ignoreregex</span><span class=w> </span><span class=o>=</span>
</span></code></pre></div> <h4 id=filter-nginx-bad-bots>Filter - Nginx Bad Bots</h4> <p>Copiare <code>apache-badbots.conf</code> come <code>nginx-badbots.conf</code>:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>sudo<span class=w> </span>cp<span class=w> </span>/etc/fail2ban/filter.d/apache-badbots.conf<span class=w> </span>/etc/fail2ban/filter.d/nginx-badbots.conf
</span></code></pre></div> <h4 id=filter-nginx-bot-search>Filter - Nginx Bot Search</h4> <p>Creare nuovo file:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>sudo<span class=w> </span>nano<span class=w> </span>/etc/fail2ban/filter.d/nginx-botsearch.conf
</span></code></pre></div> <p>Nel file copiare:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=c1># Fail2Ban filter to match web requests for selected URLs that don&#39;t exist</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=c1>#</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=k>[INCLUDES]</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=c1># Load regexes for filtering</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=n>before</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>botsearch-common.conf</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=k>[Definition]</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=n>failregex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>^&lt;HOST&gt; \- \S+ \</span><span class=p>[</span><span class=err>\] \</span><span class=s2>&quot;(GET|POST|HEAD) </span><span class=se>\/</span><span class=s2>&lt;block&gt; </span><span class=se>\S</span><span class=s2>+</span><span class=se>\&quot;</span><span class=s2> 404 .+$</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=s2>            ^ </span><span class=se>\[</span><span class=s2>error</span><span class=se>\]</span><span class=s2> </span><span class=se>\d</span><span class=s2>+#</span><span class=se>\d</span><span class=s2>+: </span><span class=se>\*\d</span><span class=s2>+ (</span><span class=se>\S</span><span class=s2>+ )?</span><span class=se>\&quot;\S</span><span class=s2>+</span><span class=se>\&quot;</span><span class=s2> (failed|is not found) </span><span class=se>\(</span><span class=s2>2</span><span class=se>\:</span><span class=s2> No such file or directory</span><span class=se>\)</span><span class=s2>, client</span><span class=se>\:</span><span class=s2> &lt;HOST&gt;</span><span class=se>\,</span><span class=s2> server</span><span class=se>\:</span><span class=s2> </span><span class=se>\S</span><span class=s2>*</span><span class=se>\,</span><span class=s2> request: </span><span class=se>\&quot;</span><span class=s2>(GET|POST|HEAD) </span><span class=se>\/</span><span class=s2>&lt;block&gt; </span><span class=se>\S</span><span class=s2>+</span><span class=se>\&quot;\,</span><span class=s2> .*?$</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=s2>ignoreregex =</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=s2># DEV Notes:</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=s2># Based on apache-botsearch filter</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=s2>#</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=s2># Author: Frantisek Sumsal</span>
</span></code></pre></div> <h4 id=filter-nginx-no-script>Filter - Nginx No Script</h4> <p>Creare nuovo file:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a>sudo<span class=w> </span>nano<span class=w> </span>nginx-noscript.conf
</span></code></pre></div> <p>Nel file copiare:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=k>[Definition]</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=n>failregex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>^&lt;HOST&gt; -.*GET.*(\.php|\.asp|\.exe|\.pl|\.cgi|\.scgi)</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=n>ignoreregex</span><span class=w> </span><span class=o>=</span>
</span></code></pre></div> <h4 id=filter-nginx-no-home>Filter - Nginx No Home</h4> <p>Creare nuovo file:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>sudo<span class=w> </span>nano<span class=w> </span>nginx-nohome.conf
</span></code></pre></div> <p>Nel file copiare:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=k>[Definition]</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=n>failregex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>^&lt;HOST&gt; -.*GET .*/~.*</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=n>ignoreregex</span><span class=w> </span><span class=o>=</span>
</span></code></pre></div> <h4 id=filter-nginx-no-proxy>Filter - Nginx No Proxy</h4> <p>Creare nuovo file:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>sudo<span class=w> </span>nano<span class=w> </span>nginx-noproxy.conf
</span></code></pre></div> <p>Nel file copiare:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=k>[Definition]</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=n>failregex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>^&lt;HOST&gt; -.*GET http.*</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=n>ignoreregex</span><span class=w> </span><span class=o>=</span>
</span></code></pre></div> <h2 id=attivazione-delle-jail-nginx>Attivazione delle Jail Nginx</h2> <p>Riavvia il servizio di Fail2Ban:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>sudo<span class=w> </span>service<span class=w> </span>fail2ban<span class=w> </span>restart
</span></code></pre></div> <h2 id=ottenere-info-su-stato-jail>Ottenere info su stato Jail</h2> <div class="language-bash highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>sudo<span class=w> </span>fail2ban-client<span class=w> </span>status
</span></code></pre></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.525ec568.min.js></script> </body> </html>